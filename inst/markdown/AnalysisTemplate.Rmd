---
title: "Data analysis example"
author: "Beth Babcock"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=TRUE)
```

```{r,message=FALSE}
library(tidyverse)
theme_set(theme_minimal())
#devtools::install_github("ebabcock/PowerAfterChange")
library(PowerAfterChange) #Library with all the new functions
```


### Read in some data

```{r}
root <- rprojroot::find_package_root_file()
fish <- read_csv(file.path(root, "data", "Fish_only - Zero_counts_&_Env._data.csv")) 
head(fish)
fishTotal<-fish %>%
  group_by(Site, Season,WYR) %>%
  summarise(number = sum(num),
            area_sampled=first(area_sampled)) %>%
  ungroup() %>%
  mutate(den=number/area_sampled)

ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01),color=Season)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


### Calculate summary statistics

The summarize_baseline function gives us the sd_within and sd_among sites in the baseline data, as well as the optionally log transformed values. 

```{r}
fishSumDry<-summarize_baseline(filter(fishTotal,Season=="DRY"),
                            siteVar ="Site",
                            responseVar = "den",
                            logTransform = TRUE,
                            logAdd = 0.00001)
fishSumDry

                            
```      

Note the warning. The sites are not sampled the same number of times. You can use the average sample size per site, but it adds  uncertainty to the power calculation. Here is the number of samples per site per season. 

```{r}
fishTotal %>%
  group_by(Season, Site) %>%
  summarise(n = n()) %>%
  group_by(Season) %>%
  summarise(mean_n = mean(n), min_n = min(n), max_n = max(n))

```


### Planning assumptions

This is the change we want to be able to detect with sufficient power. It can be on the log scale or the original scale depending on how we do the power calculation. Here we will do it on the log scale

```{r}
delta_target_log <- 0.3  #change in the mean we want to detect
sd_delta_log <- 0  #variability in true changes among sites 
nA_fixed <- 3  #number of samples after the change per site for fixed number of sites comparison
nB <- 10  #number of samples before the change per site for fixed number of sites comparison, based on minimum for the dry season.
```

### (Question 1) Find minimum sites given before and after number known sample size

In this scenario, we know how many samples we have before and after the change, and want to know how many sites are needed to achieve target power. This is equivalent to a paired t-test power calculation, and we will do it with both a simulation function and power.t.test. The function find_min_sites finds the minimum number of sites needed to achieve target power, given the number of samples before and after the change, using simulation.

```{r}
site_res <- find_min_sites(nB = nB, 
                           nA = nA_fixed,
                           delta = delta_target_log,
                           sd_w = fishSumDry$logsd_within, 
                           sd_d = sd_delta_log,
                           target_power = 0.8, alpha = 0.05,
                           S_grid = 2:200, nsim = 1000, seed = 42)

site_res$S_star  #Number of sites needed for specified power
```

We can get the same result from a t test. 

```{r}
sd_diff_hat <- getSD_difference(sd_within = fishSumDry$logsd_within,
                                 nA = nA_fixed,
                                 nB = nB,
                                 sd_delta = sd_delta_log)
sd_diff_hat
power_result <- power.t.test(n = NULL,
                              delta = delta_target_log,
                              sd = sd_diff_hat,
                              sig.level = 0.05,
                              power = 0.8,
                              type = "paired",
                              alternative = "two.sided")
power_result$n  #Number of sites needed
```

Plot to show the comparison of power across a range of site numbers for both methods.

```{r}
comparison_df <- data.frame(
  n_sites = site_res$curve$S,
  power_analytical = find_min_sites_analytical(S_grid = site_res$curve$S,
                                                     delta_target = delta_target_log,
                                                     sd_diff = sd_diff_hat),
  power_simulation = site_res$curve$power
)

# Plot comparison
ggplot(comparison_df, aes(x = n_sites)) +
  geom_line(aes(y = power_analytical, color = "power.t.test"), linewidth = 1) +
  geom_line(aes(y = power_simulation, color = "Simulation"), linewidth = 1, linetype = "dashed") +
  geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
  geom_vline(xintercept = ceiling(power_result$n), linetype = "dotted", color = "blue", alpha = 0.5) +
  geom_vline(xintercept = site_res$S_star, linetype = "dotted", color = "red", alpha = 0.5) +
  labs(
    title = "Comparison: power.t.test vs Simulation-Based Power",
    subtitle = paste0("power.t.test: n=", ceiling(power_result$n), 
                      " | Simulation: n=", site_res$S_star),
    x = "Number of Sites",
    y = "Power",
    color = "Method"
  ) +
  scale_color_manual(values = c("power.t.test" = "blue", "Simulation" = "red")) +
  theme(legend.position = "bottom")

```


### (Question 2) Find minimum n_after

In this scenario, we have a fixed number of sites and samples before the change, and want to know how many samples after the change are needed to achieve target power.The function res_n_after finds the minimum number of samples after the change needed to achieve target power, given the number of sites and samples before the change. 

```{r}
res_n_after <- find_n_after(S = length(unique(fish$Site)), 
                            nB = nB,
                            delta = delta_target_log,
                            sd_w = fishSumDry$logsd_within, 
                            sd_d = sd_delta_log,
                            target_power = 0.8, alpha = 0.05,
                            n_grid = 1:100, nsim = 1000, seed = 99)
res_n_after$n_star  #Number of after samples need for specified power
```


Calculate power for a range of nA values using simulation.

```{r}
nA_grid <- 1:100
power_values <- sapply(nA_grid, function(nA) {
  power_for_nA(nA, S = length(unique(fish$Site)), 
               nB = nB, 
               delta = delta_target_log,
                sd_within = fishSumDry$logsd_within,
                sd_delta =  sd_delta_log,
                alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
  n_after = nA_grid,
  power_analytical = power_values,
  power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
  geom_line(aes(y = power_analytical, color = "power.t.test"),
            linewidth = 1) +
  geom_line(aes(y = power_simulation, color = "Simulation"),
            linewidth = 1, linetype = "dashed") +
  geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
  geom_vline(xintercept = ceiling(res_n_after$n_star),
             linetype = "dotted", color = "red", alpha = 0.5) +
  labs(
    title = "Comparison: power.t.test vs Simulation-Based Power",
    subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
    ), " | Simulation: nA=", res_n_after$n_star),
    x = "Number of After Samples per Site",
    y = "Power",
    color = "Method"
  ) +
  scale_color_manual(values = c("power.t.test" = "blue",
                                "Simulation" = "red")) +
  theme(legend.position = "bottom")
  
```

### (Question 3) Find minimum percent change detectable

```{r}
percent_change_res <- find_min_percent_change(S = length(unique(fish$Site)), 
                                               nB = nB,
                                               nA = nA_fixed,
                                               sd_w = fishSumDry$logsd_within, 
                                               sd_d = sd_delta_log,
                                               target_power = 0.8, alpha = 0.05,
                                               percent_grid = seq(0, 100, by = 1), nsim = 1000, seed = 123)
```

