siteMean <- rnorm(S_demo, mean = before_mean, sd = sd_between)
#Genarate baseline data (before change)
baseline_demo <- data.frame(
site = rep(1:S_demo, each = mB_demo)) %>%
mutate(y = rnorm(S_demo * mB_demo, mean = siteMean[site], sd = sd_within))
sd_within_hat <-getSD_within(baseline = baseline_demo,
siteVar = "site",
responseVar = "y")
sd_within_hat
delta_target <- 1  #change in the mean we want to detect
sd_delta <- 0.5  #variability in true changes among sites
res_n_after <- find_n_after(S = S_demo, mB = mB_demo,
delta = delta_target,
sd_w = sd_within_hat, sd_d = sd_delta,
target_power = 0.8, alpha = 0.05,
n_grid = 1:40, nsim = 3000, seed = 99)
res_n_after$n_star  #Number of after samples need for specified power
head(res_n_after$curve)
# Plot power curve for number of samples after
ggplot(res_n_after$curve, aes(x = n_after, y = power)) +
geom_line() +
geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
geom_vline(xintercept = res_n_after$n_star, linetype = "dashed", color = "blue") +
labs(title = "Power Curve for Before-After Design",
x = "Number of After Samples per Site",
y = "Power")
site_res <- find_min_sites(mB = mB_demo, nA = 5,
delta = delta_target,
sd_w = sd_within_hat, sd_d = sd_delta,
target_power = 0.8, alpha = 0.05,
S_grid = 2:40, nsim = 3000, seed = 42)
site_res$S_star
# Plot power curve for sites
ggplot(site_res$curve, aes(x = S, y = power)) +
geom_line() +
geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
geom_vline(xintercept = site_res$S_star, linetype = "dashed", color = "blue") +
labs(title = "Power Curve for Number of Sites, known before and after samples",
x = "Number of Sites",
y = "Power")
getSD_difference <- function(sd_within, nA, nB, sd_delta){
sd_diff <- sqrt(sd_within^2(1/nA + 1/nB) + sd_delta^2)
return(sd_diff)
}
sd_diff_hat <- getSD_difference(sd_within = sd_within_hat,
nA = 5,
nB = 5,
sd_delta = sd_delta)
sd_within_hat
nA
nB
sd_delta
sd_diff_hat <- getSD_difference(sd_within = sd_within_hat,
nA = 5,
nB = 5,
sd_delta = sd_delta)
getSD_difference <- function(sd_within, nA, nB, sd_delta){
sd_diff <- sqrt(sd_within^2*(1/nA + 1/nB) + sd_delta^2)
return(sd_diff)
}
sd_diff_hat <- getSD_difference(sd_within = sd_within_hat,
nA = 5,
nB = 5,
sd_delta = sd_delta)
sd_diff_hat
power_result <- power.t.test(n = NULL,
delta = delta_target,
sd = sd_diff_hat,
sig.level = 0.05,
power = 0.8,
type = "paired",
alternative = "two.sided")
power_result$n  #Number of sites needed
n_grid<-2:4
sd_diff<-sd_diff_hat
sapply(n_grid, function(n) {
power.t.test(
n = n,
delta = delta_target,
sd = sd_diff,
sig.level = 0.05,
type = "one.sample",
alternative = "two.sided"
)$power
}
}
power_curve_analytical <- function(n_grid, delta_target, sd_diff){
n_grid <- n_grid[n_grid >=2]
sapply(n_grid, function(n) {
power.t.test(
n = n,
delta = delta_target,
sd = sd_diff,
sig.level = 0.05,
type = "one.sample",
alternative = "two.sided"
)$power
} )
}
#'
#' Function to use power.t.test to calculate power for a paired t-test on the means across
#'
#' @param n_grid Number of sites grid
#' @param delta_target Target mean change
#' @param sd_diff Standard deviation of difference in means
#'
#' @returns Power for each number of sites in n_grid
#' @export
#'
find_min_sites_analytical <- function(n_grid, delta_target, sd_diff){
n_grid <- n_grid[n_grid >=2]
sapply(n_grid, function(n) {
power.t.test(
n = n,
delta = delta_target,
sd = sd_diff,
sig.level = 0.05,
type = "one.sample",
alternative = "two.sided"
)$power
} )
}
find_min_sites_analytical <- function(n_grid, delta_target, sd_diff){
n_grid <- n_grid[n_grid >=2]
sapply(n_grid, function(n) {
power.t.test(
n = n,
delta = delta_target,
sd = sd_diff,
sig.level = 0.05,
type = "one.sample",
alternative = "two.sided"
)$power
} )
}
site_res
comparison_df <- data.frame(
n_sites = n_grid,
power_analytical = find_min_sites_analytical(n_grid = n_grid,
delta_target = delta_target,
sd_diff = sd_diff_hat),
power_simulation = site_res$curve$power
)
# Plot comparison
ggplot(comparison_df, aes(x = n_sites)) +
geom_line(aes(y = power_analytical, color = "power.t.test"), size = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"), size = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(power_result$n), linetype = "dotted", color = "blue", alpha = 0.5) +
geom_vline(xintercept = site_res$S_star, linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: n=", ceiling(power_result$n),
" | Simulation: n=", site_res$S_star),
x = "Number of Sites",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue", "Simulation" = "red")) +
theme_minimal() +
theme(legend.position = "bottom")
site_res
n_grid
comparison_df <- data.frame(
n_sites = site_res$curve$S,
power_analytical = find_min_sites_analytical(S_grid = site_res$curve$S,
delta_target = delta_target,
sd_diff = sd_diff_hat),
power_simulation = site_res$curve$power
)
getSD_difference <- function(sd_within, nA, nB, sd_delta){
sd_diff <- sqrt(sd_within^2*(1/nA + 1/nB) + sd_delta^2)
return(sd_diff)
}
find_min_sites_analytical <- function(S_grid, delta_target, sd_diff){
S_grid <- S_grid[S_grid >=2]
sapply(S_grid, function(n) {
power.t.test(
n = n,
delta = delta_target,
sd = sd_diff,
sig.level = 0.05,
type = "one.sample",
alternative = "two.sided"
)$power
} )
}
sd_diff_hat <- getSD_difference(sd_within = sd_within_hat,
nA = 5,
nB = 5,
sd_delta = sd_delta)
sd_diff_hat
getSD_difference <- function(sd_within, nA, nB, sd_delta){
sd_diff <- sqrt(sd_within^2*(1/nA + 1/nB) + sd_delta^2)
return(sd_diff)
}
find_min_sites_analytical <- function(S_grid, delta_target, sd_diff){
S_grid <- S_grid[S_grid >=2]
sapply(S_grid, function(n) {
power.t.test(
n = n,
delta = delta_target,
sd = sd_diff,
sig.level = 0.05,
type = "one.sample",
alternative = "two.sided"
)$power
} )
}
sd_diff_hat <- getSD_difference(sd_within = sd_within_hat,
nA = 5,
nB = 5,
sd_delta = sd_delta)
sd_diff_hat
power_result <- power.t.test(n = NULL,
delta = delta_target,
sd = sd_diff_hat,
sig.level = 0.05,
power = 0.8,
type = "paired",
alternative = "two.sided")
power_result$n  #Number of sites needed
comparison_df <- data.frame(
n_sites = site_res$curve$S,
power_analytical = find_min_sites_analytical(S_grid = site_res$curve$S,
delta_target = delta_target,
sd_diff = sd_diff_hat),
power_simulation = site_res$curve$power
)
# Plot comparison
ggplot(comparison_df, aes(x = n_sites)) +
geom_line(aes(y = power_analytical, color = "power.t.test"), size = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"), size = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(power_result$n), linetype = "dotted", color = "blue", alpha = 0.5) +
geom_vline(xintercept = site_res$S_star, linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: n=", ceiling(power_result$n),
" | Simulation: n=", site_res$S_star),
x = "Number of Sites",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue", "Simulation" = "red")) +
theme_minimal() +
theme(legend.position = "bottom")
knitr::opts_chunk$set(eval=TRUE)
library(tidyverse)
theme_set(theme_minimal())
#devtools::install_github("ebabcock/PowerAfterChange")
library(PowerAfterChange) #Library with all the new functions
set.seed(123) #for reproducibility
S_demo <- 12 #Number of sites
nB_demo <- 5 #Number of before samples per site
sd_within <- 2 #within-site standard deviation
sd_between <- 1 #between-site standard deviation
before_mean <- 10 #overall mean before change
#simulate site to site variability
siteMean <- rnorm(S_demo, mean = before_mean, sd = sd_between)
#Genarate baseline data (before change)
baseline_demo <- data.frame(
site = rep(1:S_demo, each = nB_demo)) %>%
mutate(y = rnorm(S_demo * nB_demo, mean = siteMean[site], sd = sd_within))
sd_within_hat <-getSD_within(baseline = baseline_demo,
siteVar = "site",
responseVar = "y")
sd_within_hat
knitr::opts_chunk$set(eval=FALSE)
# Function to calculate power for given nA using power.t.test
power_for_nA <- function(nA, S, nB, delta, sd_within, sd_delta, alpha){
sd_diff <- getSD_difference(sd_within, nA, nB, sd_delta)
power_result <- power.t.test(n = S,
delta = delta,
sd = sd_diff,
sig.level = alpha,
power = NULL,
type = "paired",
alternative = "two.sided")
return(power_result$power)
}
# Calculate power for a range of nA values
nA_grid <- 1:40
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = S_demo, nB = nB_demo
, delta = delta_target,
sd_within = sd_within_hat,
sd_delta = sd_delta,
alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
n_after = nA_grid,
power_analytical = power_values,
power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
size = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
size = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "d
otted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
# Function to calculate power for given nA using power.t.test
power_for_nA <- function(nA, S, nB, delta, sd_within, sd_delta, alpha){
sd_diff <- getSD_difference(sd_within, nA, nB, sd_delta)
power_result <- power.t.test(n = S,
delta = delta,
sd = sd_diff,
sig.level = alpha,
power = NULL,
type = "paired",
alternative = "two.sided")
return(power_result$power)
}
# Calculate power for a range of nA values
nA_grid <- 1:40
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = S_demo, nB = nB_demo,
delta = delta_target,
sd_within = sd_within_hat,
sd_delta = sd_delta,
alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
n_after = nA_grid,
power_analytical = power_values,
power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
size = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
size = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
})
# Function to calculate power for given nA using power.t.test
power_for_nA <- function(nA, S, nB, delta, sd_within, sd_delta, alpha){
sd_diff <- getSD_difference(sd_within, nA, nB, sd_delta)
power_result <- power.t.test(n = S,
delta = delta,
sd = sd_diff,
sig.level = alpha,
power = NULL,
type = "paired",
alternative = "two.sided")
return(power_result$power)
}
# Calculate power for a range of nA values
nA_grid <- 1:40
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = S_demo, nB = nB_demo,
delta = delta_target,
sd_within = sd_within_hat,
sd_delta = sd_delta,
alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
n_after = nA_grid,
power_analytical = power_values,
power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
size = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
size = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
#' @param S Number of sites
#' @param nB Number of before samples per site
#' @param delta Hypothesized mean change
#' @param sd_within Standard deviation within sites
#' @param sd_delta Standard deviation of true changes among sites
#' @param alpha Significance level
#'
#' @returns Power for the given number of after sample
#' @export
#'
power_for_nA <- function(nA, S, nB, delta, sd_within, sd_delta, alpha){
sd_diff <- getSD_difference(sd_within, nA, nB, sd_delta)
power_result <- power.t.test(n = S,
delta = delta,
sd = sd_diff,
sig.level = alpha,
power = NULL,
type = "paired",
alternative = "two.sided")
return(power_result$power)
}
#usethis::use_pkgdown()
devtools::check()
devtools::document()
devtools::build_readme()
pkgdown::build_site()
devtools::load_all()
pkgdown::build_site()
S_gri
devtools::install_github("ebabcock/PowerAfterChange")
library(PowerAfterChange)
rm(list=ls())
library(PowerAfterChange)
devtools::load_all()
devtools::install_github("ebabcock/PowerAfterChange")
devtools::install_github("ebabcock/PowerAfterChange")
library(PowerAfterChange)
?getSD_difference
library(tidyverse)
theme_set(theme_minimal())
#devtools::install_github("ebabcock/PowerAfterChange")
library(PowerAfterChange) #Library with all the new functions
set.seed(123) #for reproducibility
S_demo <- 12 #Number of sites
nB_demo <- 5 #Number of before samples per site
sd_within <- 2 #within-site standard deviation
sd_between <- 1 #between-site standard deviation
before_mean <- 10 #overall mean before change
#simulate site to site variability
siteMean <- rnorm(S_demo, mean = before_mean, sd = sd_between)
#Genarate baseline data (before change)
baseline_demo <- data.frame(
site = rep(1:S_demo, each = nB_demo)) %>%
mutate(y = rnorm(S_demo * nB_demo, mean = siteMean[site], sd = sd_within))
sd_within_hat <-getSD_within(baseline = baseline_demo,
siteVar = "site",
responseVar = "y")
sd_within_hat
delta_target <- 1  #change in the mean we want to detect
sd_delta <- 0.5  #variability in true changes among sites
site_res <- find_min_sites(nB = nB_demo, nA = 5,
delta = delta_target,
sd_w = sd_within_hat, sd_d = sd_delta,
target_power = 0.8, alpha = 0.05,
S_grid = 2:40, nsim = 3000, seed = 42)
site_res$S_star
# Plot power curve for sites
ggplot(site_res$curve, aes(x = S, y = power)) +
geom_line() +
geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
geom_vline(xintercept = site_res$S_star, linetype = "dashed", color = "blue") +
labs(title = "Power Curve for Number of Sites, known before and after samples",
x = "Number of Sites",
y = "Power")
sd_diff_hat <- getSD_difference(sd_within = sd_within_hat,
nA = 5,
nB = 5,
sd_delta = sd_delta)
getSD_difference
#usethis::use_pkgdown()
devtools::check()
#usethis::use_pkgdown()
devtools::check()
devtools::load_all()
devtools::document()
devtools::build_readme()
devtools::install_github("ebabcock/PowerAfterChange")
#usethis::use_pkgdown()
devtools::check()
devtools::load_all()
devtools::document()
devtools::build_readme()
pkgdown::build_site()
.Last.error
devtools::install_github("ebabcock/PowerAfterChange")
install.packages(c("BBmisc", "car", "carData", "checkmate", "deSolve", "distributional", "DLMtool", "duckdb", "e1071", "extraDistr", "fitdistrplus", "forecast", "future", "gap", "gert", "ggformula", "ggiraph", "ggsci", "ggstats", "glmmTMB", "globals", "gt", "gtExtras", "hash", "hdrcde", "Hmisc", "INLAspacetime", "insight", "jtools", "later", "lavaan", "LearnBayes", "litedown", "lmerTest", "misty", "mnormt", "paletteer", "parallelly", "pdftools", "permute", "pkgload", "plotly", "proxy", "purrr", "QuickJSR", "rbibutils", "Rdpack", "reformulas", "renv", "rfishbase", "rgl", "rlang", "RMark", "robustbase", "rosm", "RSQLite", "rstantools", "SAMtool", "sdmTMB", "segmented", "sf", "shinyBS", "shinyjs", "skimr", "sn", "snowflakeauth", "spam", "spatstat.geom", "spatstat.univar", "spatstat.utils", "terra", "testthat", "tidyterra", "timeDate", "tseries", "tweedie", "vctrs", "wk", "xfun", "yulab.utils"))
install.packages(c("cluster", "foreign", "survival"))
k
#usethis::use_pkgdown()
devtools::check()
