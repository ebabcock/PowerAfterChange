nA = nA_fixed,
delta = delta_target_log,
sd_w = fishSumDry$logsd_within,
sd_d = sd_delta_log,
target_power = 0.8, alpha = 0.05,
S_grid = 2:200, nsim = 1000, seed = 42)
site_res <- find_min_sites(nB = nB,
nA = nA_fixed,
delta = delta_target_log,
sd_w = fishSumDry$logsd_within,
sd_d = sd_delta_log,
target_power = 0.8, alpha = 0.05,
S_grid = 2:200, nsim = 1000, seed = 42)
site_res$S_star  #Number of sites needed for specified power
site_res$S_star  #Number of sites needed for specified power
sd_diff_hat <- getSD_difference(sd_within = fishSumDry$logsd_within,
nA = nA_fixed,
nB = fishSumDry$nB,
sd_delta = sd_delta_log)
sd_diff_hat
sd_diff_hat <- getSD_difference(sd_within = fishSumDry$logsd_within,
nA = nA_fixed,
nB = fishSumDry$nB,
sd_delta = sd_delta_log)
sd_diff_hat
sd_diff_hat <- getSD_difference(sd_within = fishSumDry$logsd_within,
nA = nA_fixed,
nB = nB,
sd_delta = sd_delta_log)
sd_diff_hat
power_result <- power.t.test(n = NULL,
delta = delta_target_log,
sd = sd_diff_hat,
sig.level = 0.05,
power = 0.8,
type = "paired",
alternative = "two.sided")
power_result$n  #Number of sites needed
comparison_df <- data.frame(
n_sites = site_res$curve$S,
power_analytical = find_min_sites_analytical(S_grid = site_res$curve$S,
delta_target = delta_target_log,
sd_diff = sd_diff_hat),
power_simulation = site_res$curve$power
)
# Plot comparison
ggplot(comparison_df, aes(x = n_sites)) +
geom_line(aes(y = power_analytical, color = "power.t.test"), linewidth = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"), linewidth = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(power_result$n), linetype = "dotted", color = "blue", alpha = 0.5) +
geom_vline(xintercept = site_res$S_star, linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: n=", ceiling(power_result$n),
" | Simulation: n=", site_res$S_star),
x = "Number of Sites",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue", "Simulation" = "red")) +
theme(legend.position = "bottom")
res_n_after <- find_n_after(S = length(unique(fish$Site)),
nB = fishSumDry$nB,
delta = delta_target_log,
sd_w = fishSumDry$logsd_within,
sd_d = sd_delta_log,
target_power = 0.8, alpha = 0.05,
n_grid = 1:200, nsim = 1000, seed = 99)
res_n_after <- find_n_after(S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_w = fishSumDry$logsd_within,
sd_d = sd_delta_log,
target_power = 0.8, alpha = 0.05,
n_grid = 1:200, nsim = 1000, seed = 99)
res_n_after <- find_n_after(S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_w = fishSumDry$logsd_within,
sd_d = sd_delta_log,
target_power = 0.8, alpha = 0.05,
n_grid = 1:200, nsim = 1000, seed = 99)
res_n_after$n_star  #Number of after samples need for specified power
res_n_after <- f
nA_grid <- 1:100
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = length(unique(fish$Site)),
nB = nB,
delta = delta_target,
sd_within = fishSumDry$logsd_within,
sd_delta =  sd_delta_log,
alpha = 0.05)
})
nA_grid <- 1:100
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_within = fishSumDry$logsd_within,
sd_delta =  sd_delta_log,
alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
n_after = nA_grid,
power_analytical = power_values,
power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
size = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
size = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
nA_grid <- 1:100
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_within = fishSumDry$logsd_within,
sd_delta =  sd_delta_log,
alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
n_after = nA_grid,
power_analytical = power_values,
power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
linewidth = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
linewidth = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
nA_grid <- 1:100
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_within = fishSumDry$logsd_within,
sd_delta =  sd_delta_log,
alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
n_after = nA_grid,
power_analytical = power_values,
power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
linewidth = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
linewidth = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
nA_grid <- 1:100
length(unique(fish$Site))
nB
delta_target_log
fishSumDry$logsd_within
sd_delta_log
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_within = fishSumDry$logsd_within,
sd_delta =  sd_delta_log,
alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
n_after = nA_grid,
power_analytical = power_values,
power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
linewidth = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
linewidth = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
linewidth = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
linewidth = 0.5, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
view(comparison_nA_df)
ggplot(comparison_nA_df,aes(x=power_analytical,y=power_analytical)+geom_point()
ggplot(comparison_nA_df,aes(x=power_analytical,y=power_analytical))+geom_point()
ggplot(comparison_nA_df,aes(x=power_analytical,y=power_analytical))+geom_point()+geom_abline(intercept = 0,slope = 1)
NB
nB
res_n_after <- find_n_after(S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_w = fishSumDry$logsd_within,
sd_d = sd_delta_log,
target_power = 0.8, alpha = 0.05,
n_grid = 1:100, nsim = 1000, seed = 99)
res_n_after <- find_n_after(S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_w = fishSumDry$logsd_within,
sd_d = sd_delta_log,
target_power = 0.8, alpha = 0.05,
n_grid = 1:100, nsim = 1000, seed = 99)
res_n_after$n_star  #Number of after samples need for specified power
nA_grid <- 1:100
power_values <- sapply(nA_grid, function(nA) {
power_for_nA(nA, S = length(unique(fish$Site)),
nB = nB,
delta = delta_target_log,
sd_within = fishSumDry$logsd_within,
sd_delta =  sd_delta_log,
alpha = 0.05)
})
# Create a data frame for plotting
comparison_nA_df <- data.frame(
n_after = nA_grid,
power_analytical = power_values,
power_simulation = res_n_after$curve$power
)
# Plot comparison
ggplot(comparison_nA_df, aes(x = n_after)) +
geom_line(aes(y = power_analytical, color = "power.t.test"),
linewidth = 1) +
geom_line(aes(y = power_simulation, color = "Simulation"),
linewidth = 1, linetype = "dashed") +
geom_hline(yintercept = 0.8, linetype = "dotted", color = "gray50") +
geom_vline(xintercept = ceiling(res_n_after$n_star),
linetype = "dotted", color = "red", alpha = 0.5) +
labs(
title = "Comparison: power.t.test vs Simulation-Based Power",
subtitle = paste0("power.t.test: nA=", ceiling(res_n_after$n_star
), " | Simulation: nA=", res_n_after$n_star),
x = "Number of After Samples per Site",
y = "Power",
color = "Method"
) +
scale_color_manual(values = c("power.t.test" = "blue",
"Simulation" = "red")) +
theme(legend.position = "bottom")
percent_change_res <- find_min_percent_change(S = length(unique(fish$Site)),
nB = nB,
nA = nA_fixed,
sd_w = fishSumDry$logsd_within,
sd_d = sd_delta_log,
target_power = 0.8, alpha = 0.05,
percent_grid = seq(0, 100, by = 1), nsim = 1000, seed = 123)
knitr::opts_chunk$set(eval=TRUE)
library(tidyverse)
library(tidyverse)
theme_set(theme_minimal())
devtools::install_github("ebabcock/PowerAfterChange")
#devtools::install_github("ebabcock/PowerAfterChange")
library(PowerAfterChange) #Library with all the new functions
rprojroot
root <- rprojroot::find_package_root_file()
fish <- read_csv(file.path(root, "data", "Fish_only - Zero_counts_&_Env._data.csv"))
head(fish)
head(fish)
fishTotal<-fish %>%
group_by(Site, Season,WYR) %>%
summarise(number = sum(num),
area_sampled=first(area_sampled)) %>%
ungroup() %>%
mutate(den=number/area_sampled)
ggplot(fish, aes(x = factor(Site), y = den)) +
stat_summary() +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = den)) +
geom+point(alpha=0.6) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = den)) +
geom_point(alpha=0.6) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.00001))) +
geom_point(alpha=0.6) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.00001))) +
geom_point(alpha=0.6,size=0.1) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.00001))) +
geom_point(alpha=0.6,size=0.4) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
geom_violin(alpha=0.3) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
geom_boxplot(alpha=0.3) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
geom_boxplot(color="red") +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fish, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
geom_boxplot() +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
summary(fish)
sum(fish$num)
ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
geom_boxplot() +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
gome_violin() +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01))) +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
geom_violin() +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01))) +
geom_violin() +
geom_point(alpha=0.6,size=0.4,position=position_jitter(width=0.2,height=0)) +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01))) +
geom_violin() +
facet_wrap(~Season) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01)),color=Season) +
geom_violin() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01),color=Season)) +
geom_violin() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggplot(fishTotal, aes(x = factor(Site), y = log(den+0.01),color=Season)) +
geom_boxplot() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
lm1<-lm(log(den+0.01) ~ Site * Season, data = fishTotal)
anova(lm1)
library(glmmTMB)
glm1<-glmmTMB(den ~ Year+Season + (1:SITE), data = fishTotal,
family=nbinom2)
summary(fishTotal)
glm1<-glmmTMB(den ~ WYR+Season + (1:SITE), data = fishTotal,
family=nbinom2)
glm1<-glmmTMB(den ~ WYR+Season + (1:Site), data = fishTotal,
family=nbinom2)
glm1<-glmmTMB(num ~ WYR+Season + (1:Site), data = fishTotal,
family=nbinom2)
summary(fishTotal)
glm1<-glmmTMB(number ~ WYR+Season + (1:Site), data = fishTotal,
family=nbinom2)
anova(lm1)
anova(glm1)
View(fishTotal)
View(fishTotal)
glm1<-glmmTMB(number ~ WYR*Season + (1:Site), data = fishTotal,
family=nbinom2)
glm2<-glmmTMB(number ~ WYR*Season , data = fishTotal,
family=nbinom2)
anova(glm1)
anova(glm1,glm2)
glm1<-glmmTMB(number ~ WYR*Season + (1:Site), data = fishTotal,
family=nbinom2)
glm2<-glmmTMB(number ~ WYR*Season , data = fishTotal,
family=nbinom2)
anova(glm1,glm2)
glm1<-glmmTMB(number ~ WYR+Season + (1:Site), data = fishTotal,
family=nbinom2)
glm2<-glmmTMB(number ~ WYR+Season , data = fishTotal,
family=nbinom2)
anova(glm1,glm2)
summary(glm1)
glm1<-glmmTMB(number ~ WYR+Season + (1:Site), data = fishTotal,
family=nbinom2)
glm2<-glmmTMB(number ~ WYR+Season , data = fishTotal,
family=nbinom2)
anova(glm1,glm2)
summary(glm1)
summary(glm2)
summary(glm1)
glm1<-glmmTMB(number ~ WYR+Season + (1|Site), data = fishTotal,
family=nbinom2)
glm1<-glmmTMB(number ~ WYR+Season + (1|Site), data = fishTotal,
family=nbinom2)
glm2<-glmmTMB(number ~ WYR+Season , data = fishTotal,
family=nbinom2)
glm2<-glmmTMB(number ~ WYR+Season , data = fishTotal,
family=nbinom2)
anova(glm1,glm2)
summary(glm1)
library(glmmTMB)
glm1<-glmmTMB(number ~ WYR+Season + (1|Site), data = fishTotal,
family=tweedie)
glm1<-glmmTMB(number ~ WYR+Season + (1|Site), data = fishTotal,
family=tweedie)
glm2<-glmmTMB(number ~ WYR+Season , data = fishTotal,
family=tweedie)
anova(glm1,glm2)
summary(glm1)
glm1<-glmmTMB(number ~ WYR+Season + (1|Site), data = fishTotal,
family=Tweedie)
glm1<-glmmTMB(number ~ WYR+Season + (1|Site), data = fishTotal,
family=tweedie)
glm1<-glmmTMB(den ~ WYR+Season + (1|Site), data = fishTotal,
family=tweedie)
fishSumDry<-summarize_baseline(filter(fishTotal,Season=="DRY"),
siteVar ="Site",
responseVar = "den",
logTransform = TRUE,
logAdd = 0.00001)
fishSumDry
fishTotal %>%
group_by(Season, Site) %>%
summarise(n = n()) %>%
group_by(Season) %>%
summarise(mean_n = mean(n), min_n = min(n), max_n = max(n))
delta_target_log <- 0.3  #change in the mean we want to detect
sd_delta_log <- 0  #variability in true changes among sites
nA_fixed <- 3  #number of samples after the change per site for fixed number of sites comparison
nB <- 10  #number of samples before the change per site for fixed number of sites comparison, based on minimum for the dry season.
find_min_percent_change
